<app-header></app-header>

<div class="container-fluid estimate-form">
    <h2 class="form-title">Estimate Cemetery Cleaning Cost</h2>

    <!-- Progress Steps -->
    <div class="progress-steps">
        <div *ngFor="let s of [1,2,3,4]" [class.active]="s <= step">{{ s }}</div>
    </div>

    <div *ngIf="step < 4">

        <!-- FORM BORDER -->
        <form [formGroup]="estimateForm" class="form-wrapper">

            <!-- STEP 1 -->
            <div class="step">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Cemetery No *</label>
                        <input type="text" class="form-control" formControlName="cemeteryNo"
                            placeholder="Enter Cemetery No">
                        <div class="error" *ngIf="hasError('cemeteryNo','required')">Required</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Cemetery Name *</label>
                        <input type="text" class="form-control" formControlName="cemeteryName"
                            placeholder="Enter Cemetery Name">
                        <div class="error" *ngIf="hasError('cemeteryName','required')">Required</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Name on Memorial *</label>
                        <input type="text" class="form-control" formControlName="memorialName"
                            placeholder="Enter Name on Memorial">
                        <div class="error" *ngIf="hasError('memorialName','required')">Required</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>City *</label>
                        <input type="text" class="form-control" formControlName="city" placeholder="Enter City">
                        <div class="error" *ngIf="hasError('city','required')">Required</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>State *</label>
                        <input type="text" class="form-control" formControlName="state" placeholder="Enter State">
                        <div class="error" *ngIf="hasError('state','required')">Required</div>
                    </div>
                </div>

                <h4 class="section-heading">Choose Plan *</h4>
                <div class="row">
                    <div class="col-md-4" *ngFor="let plan of allPlans">
                        <label class="plan-card"
                            [class.selected]="estimateForm.get('plan')?.value === plan.Subscription_id">
                            <input type="radio" formControlName="plan" [value]="plan.Subscription_id">
                            <div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5>{{plan.Subscription_name}}</h5>
                                    <span class="price">${{plan.Price}}</span>
                                </div>
                                <p>{{plan.discription}}</p>
                            </div>
                        </label>
                    </div>
                </div>
                <div class="error" *ngIf="hasError('plan','required')">Select a plan</div>
            </div>

            <!-- STEP 2 (Visible only when Step 1 valid) -->
            <div *ngIf="step >= 2" class="step">
                <h4 class="section-heading">Select your Cleaning Days *</h4>
                <div class="row mb-2">
                    <div class="col-md-6">
                        <label>First Cleaning Date *</label>
                        <input class="form-control" ngbDatepicker #d1="ngbDatepicker" readonly (click)="d1.toggle()"
                            formControlName="firstCleaningDate" placeholder="YYYY-MM-DD">
                        <small class="note">Recommended: March-May (Spring)</small>
                        <div class="error" *ngIf="hasError('firstCleaningDate','required')">Required</div>
                    </div>
                    <div class="col-md-6" *ngIf="selectedPlan?.Frequency === 24">
                        <label>Second Cleaning Date *</label>
                        <input class="form-control" ngbDatepicker #d2="ngbDatepicker" readonly (click)="d2.toggle()"
                            formControlName="secondCleaningDate" placeholder="YYYY-MM-DD">
                        <small class="note">Recommended: 6 months after first</small>
                        <div class="error" *ngIf="hasError('secondCleaningDate','required')">Required</div>
                    </div>
                </div>

                <div class="row mb-2">
                    <div class="col-md-6">
                        <label>Number of Years Subscribed *</label>
                        <input type="number" min="1" class="form-control" formControlName="subscriptionYears"
                            placeholder="Enter number of years">
                        <div class="error" *ngIf="hasError('subscriptionYears','required')">Required</div>
                        <div class="error" *ngIf="hasError('subscriptionYears','min')">Must be at least 1 year</div>
                    </div>
                </div>

                <h5 class="section-heading">Need Anniversary flowers? *</h5>
                <div class="form-check">
                    <input type="radio" class="form-check-input" formControlName="anniversaryFlowers" value="Yes">
                    <label class="form-check-label">Yes</label>
                </div>
                <div class="form-check">
                    <input type="radio" class="form-check-input" formControlName="anniversaryFlowers" value="No">
                    <label class="form-check-label">No</label>
                </div>
                <div class="error" *ngIf="hasError('anniversaryFlowers','required')">Select Yes or No</div>
            </div>

            <!-- STEP 3 (Visible only when Step 2 valid) -->
            <div *ngIf="step >= 3  && estimateForm.get('anniversaryFlowers')?.value === 'Yes'" class="step">
                <label class="mt-3">Anniversary Date *</label>
                <input class="form-control mb-2" ngbDatepicker #ad="ngbDatepicker" readonly (click)="ad.toggle()"
                    formControlName="anniversaryDate" placeholder="YYYY-MM-DD">
                <div class="error" *ngIf="hasError('anniversaryDate','required')">Required</div>

                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="section-heading">Choose the perfect bouquet</h4>
                    <a (click)="openFlowerModal()" class="view-more">View more</a>
                </div>

                <div class="row">
                    <div class="col-md-3" *ngFor="let flower of allFlowers | slice:0:4">
                        <div class="flower-card">
                            <img [src]="url + '/' + flower.image" class="img-fluid">
                            <h6>{{flower.Name}}</h6>
                            <p>{{flower.Description}}</p>
                            <div class="d-flex justify-content-between">
                                <span *ngIf="flower.in_stock; else outOfStock">In Stock</span>
                                <ng-template #outOfStock>
                                    <span class="text-danger">Out of Stock</span>
                                </ng-template>
                                <span class="price">${{flower.Price}}</span>
                            </div>
                            <button class="btn" [ngClass]="{
                                    'add-btn': selectedFlowerID !== flower.flower_id,
                                    'remove-btn': selectedFlowerID === flower.flower_id
                                    }" (click)="addFlower(flower.flower_id)" [disabled]="!flower.in_stock">

                                {{ selectedFlowerID === flower.flower_id ? 'Remove' : 'Add' }}
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <label>Add note on the bouquet</label>
                    <textarea class="form-control" rows="3" formControlName="note"
                        placeholder="Enter a message ....."></textarea>
                </div>
            </div>

            <!-- FINAL BUTTON -->
            <div class="text-center mt-4">
                <button type="button" class="btn submit-btn" (click)="goToSummary()">Get Estimate Cost</button>
            </div>
        </form>
    </div>

    <div class="step4" *ngIf="step === 4">
        <div class="left">
            <img src="/step4.png" alt="Summary Image">
        </div>
        <div class="right">
            <h4>Cost Summary</h4>
            <p class="subtitle">Your estimated Service Cost</p>

            <div class="plan-card" *ngIf="summary">
                <h6>{{summary.planName}}</h6>
                <div class="pre">
                    <p>{{summary.planDesc}}</p>
                    <h5>${{summary.planCost}}</h5>
                </div>
            </div>

            <div class="list">
                <h5>Included Services</h5>
                <ul>
                    <li><i class="bi bi-check2"></i> Professional headstone cleaning</li>
                    <li><i class="bi bi-check2"></i> Debris and weed removal</li>
                    <li><i class="bi bi-check2"></i> Grave site maintenance</li>
                    <li><i class="bi bi-check2"></i> Email updates after each visit</li>
                </ul>
            </div>

            <div class="plan-card" *ngIf="summary.anniversaryFlowers === 'Yes'">
                <h6>Anniversary Floral Tribute</h6>
                <div class="pre">
                    <p>{{summary.flowerName}} – {{summary.flowerNote}}</p>
                    <h5>${{summary.flowerCost}}</h5>
                </div>
            </div>

            <div class="total">
                <h2>Total Cost: </h2>
                <h2>${{summary.total | number:'1.2-2'}}</h2>
            </div>

            <div class="buttons">
                <button type="button" class="btn back-btn mt-3" (click)="goBackToForm()">Back to Edit</button>
                <button (click)="createService()" class="btn submit-btn mt-3" [disabled]="isSubmitting">
                    <span *ngIf="!isSubmitting">Submit</span>
                    <span *ngIf="isSubmitting">
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        Processing...
                    </span>
                </button>
            </div>
        </div>
    </div>

</div>

<app-footer></app-footer>